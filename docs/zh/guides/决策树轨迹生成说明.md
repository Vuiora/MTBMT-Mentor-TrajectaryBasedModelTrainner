# 决策树轨迹生成和使用说明

## 概述

已成功实现从复杂决策树中提取轨迹数据，并集成到 `trajectary.py` 系统中。系统可以：
1. 生成复杂的决策树（100,000样本，30特征，5类别，深度50）
2. 从决策树中提取轨迹数据（tendency, sequence, selection）
3. 自动添加标签（检索时间、轨迹长度、决策效果）
4. 与 `trajectary.py` 无缝集成

## 文件说明

### 1. `generate_decision_tree_trajectories.py`
**功能：** 生成复杂决策树并提取轨迹数据

**主要类和方法：**

#### `DecisionTreeTrajectoryExtractor`
从 sklearn 决策树中提取轨迹的类

**方法：**
- `extract_trajectory(sample)`: 为单个样本提取轨迹
  - 返回：`{"tendency": [...], "sequence": [...], "selection": [...]}`
- `extract_trajectories_batch(X, y)`: 批量提取轨迹

**轨迹数据说明：**
- **tendency**: 每个节点的倾向值（基于不纯度）
- **sequence**: 节点序列（深度）
- **selection**: 选择路径（"left", "right", "leaf"）

#### `generate_complex_decision_tree()`
生成复杂决策树

**参数：**
- `n_samples=100000`: 样本数
- `n_features=30`: 特征数
- `n_informative=15`: 有效特征数
- `n_redundant=5`: 冗余特征数
- `n_classes=5`: 类别数
- `max_depth=50`: 最大深度

**返回：**
- 训练好的决策树模型
- 测试数据
- 训练时间
- 测试准确率

#### `convert_to_trajectary_format()`
将提取的轨迹转换为 `trajectary.py` 可识别的格式

**添加的标签：**
- `retrieval_time`: 检索时间（秒）
- `trajectory_length`: 轨迹长度（节点数）
- `decision_effect`: 决策效果（测试准确率）

## 使用示例

### 示例1: 生成决策树和轨迹

```python
from generate_decision_tree_trajectories import (
    generate_complex_decision_tree,
    DecisionTreeTrajectoryExtractor,
    convert_to_trajectary_format
)

# 1. 生成决策树
clf, X_test, y_test, training_time, test_accuracy = generate_complex_decision_tree()

# 2. 提取轨迹
extractor = DecisionTreeTrajectoryExtractor(clf)
trajectories = extractor.extract_trajectories_batch(X_test[:100], y_test[:100])

# 3. 转换为trajectary格式
formatted_trajectories = convert_to_trajectary_format(
    trajectories,
    retrieval_time=0.001,
    decision_effect=test_accuracy
)
```

### 示例2: 使用轨迹数据

```python
from trajectary import Trajectary

# 使用生成的轨迹数据
traj_dict = formatted_trajectories[0]  # 第一条轨迹

# 创建Trajectary实例
traj = Trajectary(file_name="", trajectory_dict=traj_dict)

# 获取标签
labels = traj.get_trajectory_labels()
print(f"检索时间: {labels['retrieval_time']}")
print(f"轨迹长度: {labels['trajectory_length']}")
print(f"决策效果: {labels['decision_effect']}")

# 提取特征
features = traj.trajectory_valulization(method='full')
print(f"特征矩阵形状: {features.shape}")  # (n_nodes, 12)

# 监督学习数据准备
supervised_data = traj.trajectory_supervised_learning()
print(f"特征: {supervised_data['features'].shape}")
print(f"标签: {supervised_data['labels']}")
```

### 示例3: 批量处理

```python
from trajectary import Trajectary

# 批量处理多条轨迹
results = []
for traj_dict in formatted_trajectories[:10]:
    traj = Trajectary(file_name="", trajectory_dict=traj_dict)
    result = traj.processing()
    results.append(result)

# 所有轨迹的特征维度一致（12维）
print(f"处理了 {len(results)} 条轨迹")
print(f"所有特征维度一致: {all(r['features'].shape[1] == 12 for r in results)}")
```

## 运行测试

### 1. 生成决策树和轨迹数据

```bash
python generate_decision_tree_trajectories.py
```

**输出：**
- 训练好的决策树模型信息
- 1000条轨迹数据（保存到 `sample_trajectories.json`）
- 轨迹统计信息

**示例输出：**
```
数据集形状: X=(100000, 30), y=(100000,)
训练集准确率: 0.9435
测试集准确率: 0.7030
树深度: 33
节点数: 18079
平均轨迹长度: 18.40 节点
```

### 2. 运行完整测试

```bash
python test_trajectory_labels.py
```

**测试内容：**
- 测试1-6: 基础轨迹标签功能测试
- 测试7: **从复杂决策树生成的轨迹数据测试**（新增）

**测试7验证：**
- ✅ 轨迹标签完整性
- ✅ 特征提取功能
- ✅ 监督学习数据准备
- ✅ 批量处理能力

## 决策树特性

### 生成的决策树参数

```python
DecisionTreeClassifier(
    max_depth=50,           # 最大深度50
    min_samples_split=5,    # 最小分裂样本数
    min_samples_leaf=2,     # 最小叶子样本数
    random_state=42
)
```

### 数据集特性

```python
make_classification(
    n_samples=100000,       # 10万样本
    n_features=30,         # 30个特征
    n_informative=15,      # 15个有效特征
    n_redundant=5,          # 5个冗余特征
    n_classes=5,            # 5个类别
    random_state=42
)
```

### 实际生成的树统计

- **树深度**: 33层（受数据限制，未达到50）
- **节点数**: 约18,000个节点
- **叶子节点**: 约9,000个
- **平均轨迹长度**: 18.4个节点
- **轨迹长度范围**: 9-33个节点

## 轨迹数据格式

### 完整轨迹字典结构

```json
{
    "tendency": [0.85, 0.72, 0.68, ...],      // 节点倾向值（不纯度）
    "sequence": [0, 1, 2, 3, ...],            // 节点深度序列
    "selection": ["left", "right", "left", ...], // 选择路径
    "retrieval_time": 0.001,                  // 检索时间（秒）
    "trajectory_length": 16,                  // 轨迹长度（节点数）
    "decision_effect": 0.7030                 // 决策效果（准确率）
}
```

### 轨迹数据说明

1. **tendency（倾向值）**
   - 基于节点不纯度计算
   - 反映节点的不确定性
   - 值越小表示节点越纯

2. **sequence（序列）**
   - 节点在树中的深度
   - 从根节点（0）到叶子节点

3. **selection（选择）**
   - "left": 选择左子树
   - "right": 选择右子树
   - "leaf": 到达叶子节点

## 性能指标

### 生成性能

- **训练时间**: ~3.7秒（100,000样本，30特征）
- **轨迹提取**: ~0.15秒（1000个样本）
- **平均提取速度**: ~0.15毫秒/样本

### 轨迹统计

- **平均轨迹长度**: 18.4节点
- **最短轨迹**: 9节点
- **最长轨迹**: 33节点
- **轨迹长度标准差**: 4.81

## 集成验证

### 与 trajectary.py 的集成

✅ **完全兼容**: 生成的轨迹数据完全符合 `trajectary.py` 的格式要求

✅ **标签完整**: 自动包含所有必需标签
- 检索时间
- 轨迹长度
- 决策效果

✅ **特征提取**: 支持所有特征提取方法
- `concatenate`: 3维
- `with_interaction`: 6维
- `with_statistics`: 9维
- `full`: 12维

✅ **监督学习**: 支持监督学习数据准备
- 特征矩阵: (n_nodes, 12)
- 标签字典: 包含所有标签

## 文件输出

运行 `generate_decision_tree_trajectories.py` 会生成：

- `sample_trajectories.json`: 包含1000条示例轨迹的JSON文件
- 可以直接用于测试和开发

## 总结

✅ 成功实现了复杂决策树的生成和轨迹提取
✅ 轨迹数据完全兼容 `trajectary.py` 系统
✅ 所有测试通过，功能正常
✅ 支持批量处理和特征提取
✅ 自动添加完整的标签信息

现在可以使用生成的复杂决策树轨迹数据来测试和开发轨迹分析系统！

