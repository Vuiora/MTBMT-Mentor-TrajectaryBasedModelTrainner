# 轨迹标签功能说明

## 概述

已更新 `trajectary.py`，确保每条轨迹都包含以下三个标签：
1. **检索时间** (retrieval_time)
2. **轨迹长度** (trajectory_length)
3. **决策效果** (decision_effect)

## 新增功能

### 1. 自动验证和补充标签

在 `__init__` 方法中自动调用 `_validate_trajectory_labels()`，确保：
- 如果缺少标签，自动设置默认值或计算
- 如果轨迹长度与实际数据不一致，自动更新
- 发出警告提示缺失的标签

### 2. 标签管理方法

#### `get_trajectory_labels()` - 获取标签
```python
labels = traj.get_trajectory_labels()
# 返回: {
#     "retrieval_time": float,
#     "trajectory_length": int,
#     "decision_effect": float
# }
```

#### `set_trajectory_labels()` - 设置标签
```python
traj.set_trajectory_labels(
    retrieval_time=0.125,
    trajectory_length=5,
    decision_effect=0.92
)
```

### 3. 更新的方法

#### `trajectory_valulization()` - 支持标签验证
- 自动验证和补充标签
- 支持使用 `self.trajectory_dict` 或传入新的字典

#### `trajectory_supervised_learning()` - 返回特征和标签
```python
result = traj.trajectory_supervised_learning()
# 返回: {
#     "features": np.array,  # (n_samples, 12) 特征矩阵
#     "labels": {
#         "retrieval_time": float,
#         "trajectory_length": int,
#         "decision_effect": float
#     }
# }
```

#### `processing()` - 完整处理流程
```python
result = traj.processing()
# 返回: {
#     "features": np.array,  # 特征矩阵
#     "labels": dict          # 轨迹标签
# }
```

#### `save_trajectory_with_labels()` - 保存带标签的轨迹
```python
traj.save_trajectory_with_labels("trajectory.json")
```

## 数据结构

### 完整的轨迹字典结构

```python
trajectory_dict = {
    # 必需：轨迹数据
    "tendency": [0.8, 0.6, 0.9, 0.7],
    "sequence": [1, 2, 3, 2],
    "selection": ["left", "right", "left", "right"],
    
    # 必需：轨迹标签
    "retrieval_time": 0.125,      # 检索时间（秒）
    "trajectory_length": 4,       # 轨迹长度（节点数）
    "decision_effect": 0.92       # 决策效果（如准确率、收益等）
}
```

## 使用示例

### 示例1: 创建带标签的轨迹

```python
from trajectary import Trajectary

# 方式1: 直接提供完整数据
trajectory_dict = {
    "tendency": [0.8, 0.6, 0.9],
    "sequence": [1, 2, 3],
    "selection": ["left", "right", "left"],
    "retrieval_time": 0.125,
    "trajectory_length": 3,
    "decision_effect": 0.92
}

traj = Trajectary(file_name="", trajectory_dict=trajectory_dict)
labels = traj.get_trajectory_labels()
print(labels)
```

### 示例2: 自动补充缺失标签

```python
# 方式2: 只提供轨迹数据，标签会自动补充
trajectory_dict = {
    "tendency": [0.8, 0.6, 0.9],
    "sequence": [1, 2, 3],
    "selection": ["left", "right", "left"]
    # 缺少标签，会自动设置默认值
}

traj = Trajectary(file_name="", trajectory_dict=trajectory_dict)
# 自动计算轨迹长度，其他标签设为默认值
labels = traj.get_trajectory_labels()
```

### 示例3: 手动设置标签

```python
trajectory_dict = {
    "tendency": [0.8, 0.6, 0.9],
    "sequence": [1, 2, 3],
    "selection": ["left", "right", "left"]
}

traj = Trajectary(file_name="", trajectory_dict=trajectory_dict)
traj.set_trajectory_labels(
    retrieval_time=0.15,
    trajectory_length=3,
    decision_effect=0.88
)
```

### 示例4: 监督学习数据准备

```python
trajectory_dict = {
    "tendency": [0.8, 0.6, 0.9, 0.7],
    "sequence": [1, 2, 3, 2],
    "selection": ["left", "right", "left", "right"],
    "retrieval_time": 0.12,
    "trajectory_length": 4,
    "decision_effect": 0.90
}

traj = Trajectary(file_name="", trajectory_dict=trajectory_dict)
supervised_data = traj.trajectory_supervised_learning()

# 获取特征和标签
features = supervised_data["features"]  # (4, 12) 特征矩阵
labels = supervised_data["labels"]      # 标签字典
```

### 示例5: 完整处理流程

```python
trajectory_dict = {
    "tendency": [0.8, 0.6, 0.9],
    "sequence": [1, 2, 3],
    "selection": ["left", "right", "left"],
    "retrieval_time": 0.125,
    "trajectory_length": 3,
    "decision_effect": 0.92
}

traj = Trajectary(file_name="", trajectory_dict=trajectory_dict)
result = traj.processing()

# 获取处理结果
features = result["features"]  # 特征矩阵
labels = result["labels"]      # 标签
```

## 标签说明

### 检索时间 (retrieval_time)
- **类型**: float
- **单位**: 秒
- **含义**: 执行该轨迹的检索/搜索时间
- **默认值**: 0.0（如果未提供）

### 轨迹长度 (trajectory_length)
- **类型**: int
- **单位**: 节点数
- **含义**: 轨迹包含的节点数量
- **自动计算**: 如果未提供，自动从 `tendency` 或 `sequence` 的长度计算

### 决策效果 (decision_effect)
- **类型**: float
- **含义**: 该轨迹的决策效果，可以是：
  - 准确率（0.0 - 1.0）
  - 收益值
  - 其他效果指标
- **默认值**: 0.0（如果未提供）

## 验证机制

系统会自动验证：
1. ✅ 所有必需的标签是否存在
2. ✅ 轨迹长度是否与实际数据一致
3. ✅ 标签值的类型是否正确

如果发现问题，会自动：
- 补充缺失的标签（使用默认值或计算值）
- 更新不一致的轨迹长度
- 发出警告提示

## 测试

运行测试文件验证功能：

```bash
python test_trajectory_labels.py
```

测试覆盖：
- ✅ 完整标签数据
- ✅ 缺少标签的自动补充
- ✅ 手动设置标签
- ✅ 监督学习数据准备
- ✅ 完整处理流程
- ✅ 所有轨迹的标签完整性验证

## 总结

现在每条轨迹都确保包含：
1. ✅ **检索时间** (retrieval_time)
2. ✅ **轨迹长度** (trajectory_length)
3. ✅ **决策效果** (decision_effect)

这些标签可以用于：
- 监督学习模型训练
- 轨迹性能分析
- 决策效果评估
- 轨迹质量排序

